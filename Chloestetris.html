<!doctype html>
<meta charset="utf-8">
<title>Soft Tetris</title>
<canvas id=c></canvas>
<script>
c.width=240
c.height=400
ctx=c.getContext("2d")

S=20
W=10
H=20

// ---------- GRID ----------
grid=[...Array(H)].map(_=>Array(W).fill(0))

// ---------- TEXTURE BASE ----------
function makeTex(seed){
  let o=document.createElement("canvas")
  o.width=o.height=8
  let x=o.getContext("2d")

  // base
  x.fillStyle="#242424"
  x.fillRect(0,0,8,8)

  // subtle grain
  x.fillStyle="rgba(255,255,255,.04)"
  for(let i=0;i<6;i++)
    x.fillRect((i*3+seed)%8,(i*5+seed)%8,1,1)

  // faint lines
  x.fillStyle="rgba(255,255,255,.05)"
  x.fillRect(seed%4,0,1,8)

  return ctx.createPattern(o,"repeat")
}

// 7 extremely similar variants
TEX=[...Array(7)].map((_,i)=>makeTex(i))

// ---------- PIECES ----------
P=[
 [[1,1,1,1]],
 [[1,1],[1,1]],
 [[0,1,0],[1,1,1]],
 [[0,1,1],[1,1,0]],
 [[1,1,0],[0,1,1]],
 [[1,0,0],[1,1,1]],
 [[0,0,1],[1,1,1]]
]

function rot(m){
  return m[0].map((_,i)=>m.map(r=>r[i]).reverse())
}

// ---------- STATE ----------
p=null
px=0
py=0
pt=0
tick=0

function spawn(){
  pt=0|Math.random()*7
  p=P[pt]
  px=3
  py=0
}
spawn()

// ---------- COLLISION ----------
function hit(nx,ny,nm){
  for(let y=0;y<nm.length;y++)
    for(let x=0;x<nm[y].length;x++)
      if(nm[y][x]){
        if(
          nx+x<0 ||
          nx+x>=W ||
          ny+y>=H ||
          grid[ny+y]?.[nx+x]
        ) return 1
      }
}

// ---------- LOCK ----------
function lock(){
  for(let y=0;y<p.length;y++)
    for(let x=0;x<p[y].length;x++)
      if(p[y][x])
        grid[py+y][px+x]=pt+1
  clearLines()
  spawn()
}

// ---------- CLEAR ----------
function clearLines(){
  for(let y=H-1;y>=0;y--)
    if(grid[y].every(v=>v)){
      grid.splice(y,1)
      grid.unshift(Array(W).fill(0))
      y++
    }
}

// ---------- INPUT ----------
onkeydown=e=>{
  if(e.key=="ArrowLeft"&&!hit(px-1,py,p))px--
  if(e.key=="ArrowRight"&&!hit(px+1,py,p))px++
  if(e.key=="ArrowDown"&&!hit(px,py+1,p))py++
  if(e.key=="ArrowUp"){
    let r=rot(p)
    if(!hit(px,py,r))p=r
  }
}

// ---------- LOOP ----------
function loop(){
  // background
  ctx.fillStyle="#1e1e1e"
  ctx.fillRect(0,0,c.width,c.height)

  // soft noise
  ctx.fillStyle="rgba(255,255,255,.015)"
  for(let i=0;i<60;i++)
    ctx.fillRect(Math.random()*c.width,Math.random()*c.height,1,1)

  // gravity
  if(++tick>30){
    tick=0
    if(!hit(px,py+1,p))py++
    else lock()
  }

  // grid
  for(let y=0;y<H;y++)
    for(let x=0;x<W;x++)
      if(grid[y][x]){
        ctx.fillStyle=TEX[grid[y][x]-1]
        ctx.fillRect(x*S,y*S,S,S)
      }

  // active piece
  ctx.fillStyle=TEX[pt]
  for(let y=0;y<p.length;y++)
    for(let x=0;x<p[y].length;x++)
      if(p[y][x])
        ctx.fillRect((px+x)*S,(py+y)*S,S,S)

  requestAnimationFrame(loop)
}
loop()
</script>
